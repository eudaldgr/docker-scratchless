name: Certutil Auto Build
on:
  workflow_dispatch:
  schedule:
    - cron: "0 4/12 * * *"

jobs:
  build:
    name: Build and push image if new release
    runs-on: ubuntu-22.04
    permissions:
      contents: read
      packages: write
    steps:
      - name: Resolve latest version
        id: version
        run: |
          set -euo pipefail

          ALPINE_EDGE="edge"
          PKG="nss-tools"

          FULL="$(docker run --rm alpine:${ALPINE_EDGE} sh -lc "
            apk add --no-cache \
              --repository=https://dl-cdn.alpinelinux.org/alpine/${ALPINE_EDGE}/main \
              --repository=https://dl-cdn.alpinelinux.org/alpine/${ALPINE_EDGE}/community \
              ${PKG} >/dev/null
            apk info ${PKG} | head -n1 | sed -E 's/^${PKG}-([^ ]+).*/\1/'
          ")"

          if [ -z "${FULL:-}" ] || [ "${FULL}" = "${PKG}" ]; then
            echo "Could not resolve ${PKG} version from Alpine ${ALPINE_EDGE}" >&2
            exit 1
          fi

          BASE="${FULL%%-r*}"      # e.g. 3.118.1
          MAJOR="${BASE%%.*}"      # 3

          # Handle both "3.114" and "3.118.1"
          if echo "${BASE}" | grep -qE '^[0-9]+\.[0-9]+\.[0-9]+$'; then
            MINOR="${BASE%.*}"     # 3.118
            PATCH="${BASE}"        # 3.118.1
          else
            MINOR="${BASE}"        # 3.114
            PATCH="${BASE}"        # 3.114
          fi

          echo "full=${FULL}" >> "$GITHUB_OUTPUT"
          echo "major=${MAJOR}" >> "$GITHUB_OUTPUT"
          echo "minor=${MINOR}" >> "$GITHUB_OUTPUT"
          echo "patch=${PATCH}" >> "$GITHUB_OUTPUT"

      - name: Get GHCR token
        id: ghcr
        run: |
          set -euo pipefail
          TOKEN="$(curl -fsSL -u "${{ github.actor }}:${{ secrets.GITHUB_TOKEN }}" "https://ghcr.io/token?service=ghcr.io&scope=repository:${{ github.repository_owner }}/scratchless:pull" | jq -r '.token')"
          if [ -z "${TOKEN}" ] || [ "${TOKEN}" = "null" ]; then
            echo "Failed to obtain GHCR token" >&2
            exit 1
          fi
          echo "token=${TOKEN}" >> "$GITHUB_OUTPUT"

      - name: Check if tag exists in GHCR
        id: exists
        run: |
          set -euo pipefail
          TAG="${{ steps.version.outputs.full }}"
          TAGS_JSON="$(curl -fsSL -H "Authorization: Bearer ${{ steps.ghcr.outputs.token }}" "https://ghcr.io/v2/${{ github.repository_owner }}/scratchless/tags/list" || true)"
          if echo "${TAGS_JSON}" | jq -e --arg t "certutil-${TAG}" '.tags | index($t) != null' > /dev/null; then
            echo "needs_build=false" >> "$GITHUB_OUTPUT"
          else
            echo "needs_build=true" >> "$GITHUB_OUTPUT"
          fi

      - uses: actions/checkout@v4
        if: steps.exists.outputs.needs_build == 'true'

      - name: Login to GitHub Container Registry
        if: steps.exists.outputs.needs_build == 'true'
        run: echo "${{ secrets.GITHUB_TOKEN }}" | docker login ghcr.io -u "${{ github.repository_owner }}" --password-stdin

      - name: Setup Docker buildx
        if: steps.exists.outputs.needs_build == 'true'
        run: docker buildx create --use

      - name: Build and push image
        if: steps.exists.outputs.needs_build == 'true'
        run: |
          set -euo pipefail
          docker buildx build \
            --platform linux/amd64,linux/arm64 \
            --file certutil.dockerfile \
            --build-arg APP_IMAGE=${{ github.repository_owner }}/scratchless:certutil \
            --build-arg APP_NAME=certutil \
            --build-arg APP_ROOT=/scratchless \
            --build-arg APP_VERSION=${{ steps.version.outputs.full }} \
            --cache-from type=registry,ref=ghcr.io/${{ github.repository_owner }}/scratchless:buildcache-certutil \
            --cache-to type=registry,ref=ghcr.io/${{ github.repository_owner }}/scratchless:buildcache-certutil,mode=max \
            --tag ghcr.io/${{ github.repository_owner }}/scratchless:certutil-${{ steps.version.outputs.major }} \
            --tag ghcr.io/${{ github.repository_owner }}/scratchless:certutil-${{ steps.version.outputs.minor }} \
            --tag ghcr.io/${{ github.repository_owner }}/scratchless:certutil-${{ steps.version.outputs.patch }} \
            --tag ghcr.io/${{ github.repository_owner }}/scratchless:certutil-${{ steps.version.outputs.full }} \
            --tag ghcr.io/${{ github.repository_owner }}/scratchless:certutil \
            --push .
