name: Qt Minimal Auto Build
on:
  workflow_dispatch:
  schedule:
    - cron: "0 4/12 * * *"

jobs:
  qt_minimal:
    name: Build and push Qt Minimal image if new release
    runs-on: ubuntu-22.04
    permissions:
      contents: read
      packages: write
    steps:
      - name: Resolve latest Qt and OpenSSL versions
        id: version
        run: |
          set -euo pipefail
          QT_TAG="$(curl -fsSL https://api.github.com/repos/qt/qtbase/tags?per_page=100 | jq -r '.[].name | select(test("^v[0-9]+\\.[0-9]+\\.[0-9]+$"))' | sort -V | tail -n1)"
          if [ -z "${QT_TAG}" ] || [ "${QT_TAG}" = "null" ]; then
            echo "Could not resolve latest Qt tag"
            exit 1
          fi
          OPENSSL_TAG="$(curl -fsSL https://api.github.com/repos/openssl/openssl/releases/latest | jq -r '.tag_name')"
          if [ -z "${OPENSSL_TAG}" ] || [ "${OPENSSL_TAG}" = "null" ]; then
            echo "Could not resolve latest OpenSSL release tag"
            exit 1
          fi
          VERSION="${QT_TAG#v}"
          MINOR="${VERSION%.*}"
          MAJOR="${VERSION%%.*}"
          OPENSSL_VERSION="${OPENSSL_TAG#openssl-}"
          echo "qt_tag=${QT_TAG}" >> "$GITHUB_OUTPUT"
          echo "version=${VERSION}" >> "$GITHUB_OUTPUT"
          echo "minor=${MINOR}" >> "$GITHUB_OUTPUT"
          echo "major=${MAJOR}" >> "$GITHUB_OUTPUT"
          echo "openssl_version=${OPENSSL_VERSION}" >> "$GITHUB_OUTPUT"

      - name: Check if tag exists in GHCR
        id: exists
        run: |
          set -euo pipefail
          TAG="${{ steps.version.outputs.version }}"
          if curl -fsSL "https://ghcr.io/v2/eudaldgr/scratchless/tags/list" | jq -e --arg t "qt-minimal-${TAG}" '.tags | index($t) != null' > /dev/null; then
            echo "needs_build=false" >> "$GITHUB_OUTPUT"
            echo "Tag qt-minimal-${TAG} already exists in GHCR, skipping build."
          else
            echo "needs_build=true" >> "$GITHUB_OUTPUT"
            echo "Tag qt-minimal-${TAG} missing in GHCR, will build."
          fi

      - uses: actions/checkout@v4
        if: steps.exists.outputs.needs_build == 'true'

      - name: Login to GitHub Container Registry
        if: steps.exists.outputs.needs_build == 'true'
        run: echo "${{ secrets.GITHUB_TOKEN }}" | docker login ghcr.io -u "${{ github.repository_owner }}" --password-stdin

      - name: Setup Docker buildx
        if: steps.exists.outputs.needs_build == 'true'
        run: docker buildx create --use

      - name: Build and push Qt Minimal image
        if: steps.exists.outputs.needs_build == 'true'
        run: |
          set -euo pipefail
          docker buildx build \
            --platform linux/amd64,linux/arm64 \
            --file qt-minimal.dockerfile \
            --build-arg APP_VERSION=${{ steps.version.outputs.version }} \
            --build-arg APP_OPENSSL_VERSION=${{ steps.version.outputs.openssl_version }} \
            --build-arg APP_NAME=qt-minimal \
            --build-arg APP_IMAGE=ghcr.io/${{ github.repository_owner }}/scratchless:qt-minimal-${{ steps.version.outputs.version }} \
            --build-arg APP_ROOT=/scratchless \
            --tag ghcr.io/${{ github.repository_owner }}/scratchless:qt-minimal-${{ steps.version.outputs.version }} \
            --tag ghcr.io/${{ github.repository_owner }}/scratchless:qt-minimal-${{ steps.version.outputs.minor }} \
            --tag ghcr.io/${{ github.repository_owner }}/scratchless:qt-minimal-${{ steps.version.outputs.major }} \
            --tag ghcr.io/${{ github.repository_owner }}/scratchless:qt-minimal \
            --push .
